<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eSSL Multi-Device Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .device-card {
            border-left: 4px solid;
            transition: all 0.3s;
        }
        .device-active {
            border-left-color: #10b981;
        }
        .device-inactive {
            border-left-color: #ef4444;
            opacity: 0.7;
        }
        .raw-data-container {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #f0f0f0;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 12px;
            border: 1px solid #333;
        }
        .data-line {
            border-bottom: 1px solid #2d2d2d;
            padding: 4px 0;
            margin: 2px 0;
        }
        .data-line:hover {
            background: #2d2d2d;
        }
        .hex-view {
            color: #4ade80;
        }
        .ascii-view {
            color: #60a5fa;
        }
        .tab-button {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-button.active {
            background: #3b82f6;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .device-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }
        .status-offline {
            background: #ef4444;
        }
        .blink {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .log-timestamp {
            color: #9ca3af;
            font-family: monospace;
            font-size: 11px;
            min-width: 140px;
        }
        .log-message {
            word-break: break-word;
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-checkin {
            background: #10b981;
            color: white;
        }
        .status-checkout {
            background: #ef4444;
            color: white;
        }
        .status-breakout {
            background: #f59e0b;
            color: white;
        }
        .status-breakin {
            background: #8b5cf6;
            color: white;
        }
        .status-other {
            background: #6b7280;
            color: white;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-satellite-dish mr-3 text-blue-600"></i>
                eSSL Multi-Device Monitor
            </h1>
            <p class="text-gray-600 mb-6">Real-time monitoring for biometric devices - Full Attendance Logs</p>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="text-2xl font-bold text-blue-600">{{ total_records }}</div>
                    <div class="text-sm text-gray-600">Total Records</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="text-2xl font-bold text-green-600">{{ today_records }}</div>
                    <div class="text-sm text-gray-600">Today's Records</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="text-2xl font-bold text-purple-600">{{ unique_users }}</div>
                    <div class="text-sm text-gray-600">Unique Users</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="text-2xl font-bold {% if device_connected %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if device_connected %}Connected{% else %}Disconnected{% endif %}
                    </div>
                    <div class="text-sm text-gray-600">Device Status</div>
                </div>
            </div>
        </header>

        <!-- DEVICE SECTION -->
        <div class="card mb-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-microchip mr-2 text-blue-600"></i>
                        Device Information
                    </h2>
                    <div class="text-sm text-gray-600 mt-1">
                        <span class="{% if device_connected %}text-green-600{% else %}text-red-600{% endif %}">
                            <i class="fas fa-circle text-xs mr-1"></i>
                            {% if device_connected %}Online{% else %}Offline{% endif %}
                        </span>
                        <span class="ml-4 text-gray-500">
                            <i class="fas fa-clock mr-1"></i>Last contact: {{ last_contact }}
                        </span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="forceFetchAll()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                        <i class="fas fa-bolt mr-2"></i>Force Fetch ALL Logs
                    </button>
                    <button onclick="sendCommand('GET ATTLOG ALL')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                        <i class="fas fa-broadcast-tower mr-2"></i>Get ALL Attendance
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <div class="device-card {% if device_connected %}device-active{% else %}device-inactive{% endif %} p-4 bg-white rounded-lg shadow border border-gray-200">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800 mb-1">
                                <span class="device-status {% if device_connected %}status-online blink{% else %}status-offline{% endif %}"></span>
                                {{ device_sn }}
                            </h3>
                            <div class="text-sm text-gray-600">
                                <span class="inline-block mr-4"><i class="fas fa-calendar mr-1"></i>First seen: {{ current_time.split('T')[0] }}</span>
                                <span class="inline-block"><i class="fas fa-clock mr-1"></i>Last contact: {{ last_contact }}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium {% if device_connected %}text-green-600{% else %}text-red-600{% endif %}">
                                {% if device_connected %}
                                    Active
                                {% else %}
                                    Offline
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Status</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500 mb-1">Records</div>
                            <div class="text-lg font-bold text-blue-600">{{ total_records }}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500 mb-1">Today's Records</div>
                            <div class="text-lg font-bold text-purple-600">{{ today_records }}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500 mb-1">Unique Users</div>
                            <div class="text-lg font-bold text-gray-800">{{ unique_users }}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500 mb-1">Queue</div>
                            <div class="text-lg font-bold text-orange-600">{{ queue|length }}</div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="sendCommand('GET ATTLOG ALL')" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm flex items-center justify-center">
                            <i class="fas fa-download mr-2"></i>Get ALL Data
                        </button>
                        <button onclick="viewDeviceDetails()" 
                                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded text-sm flex items-center justify-center">
                            <i class="fas fa-info-circle mr-2"></i>Details
                        </button>
                        <button onclick="sendCommand('REBOOT')" 
                                class="flex-1 bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm flex items-center justify-center">
                            <i class="fas fa-power-off mr-2"></i>Reboot
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- LOGS MONITOR -->
            <div class="card lg:col-span-2">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-terminal mr-2 text-green-600"></i>
                            Communication Logs
                        </h2>
                        <div class="text-sm text-gray-600 mt-1">Device communication and system activities</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="clearLogs()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
                            <i class="fas fa-trash mr-2"></i>Clear Logs
                        </button>
                        <button onclick="exportLogs()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                            <i class="fas fa-download mr-2"></i>Export Logs
                        </button>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Logs ({{ logs|length }} entries)</span>
                        <span id="logStats">Latest entries</span>
                    </div>
                    <div class="raw-data-container" id="logContainer">
                        {% if logs %}
                            {% for log in logs[-100:]|reverse %}
                            <div class="data-line">
                                <div class="text-xs text-gray-500 mb-1">
                                    {{ log[:24] }}
                                </div>
                                <div class="text-green-400">
                                    {{ log[24:] }}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-gray-500 text-center py-8">
                                <i class="fas fa-database text-3xl mb-3"></i>
                                <p>No logs available</p>
                                <p class="text-sm mt-1">Waiting for device communications...</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-4 text-center">
                    <div class="bg-blue-50 p-3 rounded">
                        <div class="text-lg font-bold text-blue-600">{{ logs|length }}</div>
                        <div class="text-xs text-blue-500">Total Logs</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded">
                        <div class="text-lg font-bold text-green-600">{{ queue|length }}</div>
                        <div class="text-xs text-green-500">Queue Size</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded">
                        <div class="text-lg font-bold text-purple-600">{{ total_records }}</div>
                        <div class="text-xs text-purple-500">Records</div>
                    </div>
                    <div class="bg-orange-50 p-3 rounded">
                        <div class="text-lg font-bold text-orange-600" id="refreshCount">0</div>
                        <div class="text-xs text-orange-500">Next Refresh</div>
                    </div>
                </div>
            </div>

            <!-- QUICK ACTIONS -->
            <div class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-bolt mr-2 text-yellow-600"></i>
                    Quick Actions
                </h2>
                
                <div class="space-y-3">
                    <button onclick="forceFetchAll()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white p-3 rounded-lg flex items-center justify-between transition-colors">
                        <span>Force Fetch ALL Logs</span>
                        <i class="fas fa-bolt"></i>
                    </button>
                    
                    <button onclick="sendCommand('GET ATTLOG ALL')" class="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg flex items-center justify-between transition-colors">
                        <span>Get ALL Attendance Logs</span>
                        <i class="fas fa-history"></i>
                    </button>
                    
                    <button onclick="sendCommand('GET OPTION')" class="w-full bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg flex items-center justify-between transition-colors">
                        <span>Get Device Info</span>
                        <i class="fas fa-info-circle"></i>
                    </button>
                    
                    <button onclick="sendCommand('REBOOT')" class="w-full bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg flex items-center justify-between transition-colors">
                        <span>Reboot Device</span>
                        <i class="fas fa-power-off"></i>
                    </button>
                    
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium text-gray-700 mb-3">Manual Command</h3>
                        <div class="flex gap-2">
                            <select id="manualCommand" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                                {% for cmd in commands %}
                                <option value="{{ cmd }}">{{ cmd }}</option>
                                {% endfor %}
                            </select>
                            <button onclick="sendManualCommand()" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="mt-2 text-xs text-gray-500">
                            <p>Selected endpoint: <code>/iclock/getrequest.aspx</code></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ATTENDANCE RECORDS -->
        <div class="card mt-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-history mr-2 text-purple-600"></i>
                        Recent Attendance Records
                    </h2>
                    <div class="text-sm text-gray-600 mt-1">Latest 100 records • Check-out entries in red</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="refreshAttendance()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button onclick="exportAttendance()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-file-export mr-2"></i>Export CSV
                    </button>
                    <button onclick="clearAttendance()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-trash mr-2"></i>Clear
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Verification</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Workcode</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="attendanceTable">
                        {% if attendance %}
                            {% for line in attendance %}
                            {% set parts = line.split('\t') %}
                            {% if parts|length >= 3 %}
                            <tr class="hover:bg-gray-50 {% if parts[2] == '1' %}bg-red-50{% elif parts[2] == '0' %}bg-green-50{% endif %}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-bold text-gray-900">{{ parts[0] }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if parts[1]|length >= 10 %}
                                    <div class="text-sm text-gray-900 font-medium">{{ parts[1][:10] }}</div>
                                    {% else %}
                                    <div class="text-sm text-gray-900 font-medium">{{ parts[1] }}</div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if parts[1]|length >= 10 %}
                                    <div class="text-sm font-bold text-gray-900">{{ parts[1][11:] if parts[1]|length > 10 else '' }}</div>
                                    {% else %}
                                    <div class="text-sm font-bold text-gray-900"></div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if parts[2] == '0' %}
                                        <span class="status-badge status-checkin">Check-in</span>
                                    {% elif parts[2] == '1' %}
                                        <span class="status-badge status-checkout">Check-out</span>
                                    {% elif parts[2] == '2' %}
                                        <span class="status-badge status-breakout">Break-out</span>
                                    {% elif parts[2] == '3' %}
                                        <span class="status-badge status-breakin">Break-in</span>
                                    {% else %}
                                        <span class="status-badge status-other">Code {{ parts[2] }}</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ parts[3] if parts|length > 3 else '' }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ parts[4] if parts|length > 4 else '' }}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                    <i class="fas fa-inbox text-4xl mb-4 text-gray-400"></i>
                                    <p class="font-medium text-lg mb-2">No attendance records yet</p>
                                    <p class="text-sm mb-4">Fetch data from device using Quick Actions</p>
                                    <button onclick="sendCommand('GET ATTLOG ALL')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center mx-auto">
                                        <i class="fas fa-download mr-2"></i>Fetch Attendance Data
                                    </button>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            {% if attendance %}
            <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        Showing <span class="font-bold">{{ attendance|length }}</span> of <span class="font-bold">{{ total_records }}</span> total records
                    </div>
                    <div class="flex gap-2 text-xs">
                        <span class="flex items-center"><span class="inline-block w-3 h-3 bg-green-600 rounded mr-1"></span> Check-in</span>
                        <span class="flex items-center ml-4"><span class="inline-block w-3 h-3 bg-red-600 rounded mr-1"></span> Check-out</span>
                        <span class="flex items-center ml-4"><span class="inline-block w-3 h-3 bg-yellow-600 rounded mr-1"></span> Break-out</span>
                        <span class="flex items-center ml-4"><span class="inline-block w-3 h-3 bg-purple-600 rounded mr-1"></span> Break-in</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- COMMAND QUEUE -->
        <div class="card mt-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-list-ol mr-2 text-orange-600"></i>
                        Command Queue
                    </h2>
                    <div class="text-sm text-gray-600 mt-1">Commands waiting to be sent to device</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="clearQueue()" class="text-sm text-red-600 hover:text-red-800 flex items-center">
                        <i class="fas fa-trash mr-1"></i> Clear Queue
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="queueContainer">
                {% if queue %}
                    {% for cmd in queue %}
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start">
                            <div class="font-medium text-gray-800">{{ cmd }}</div>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{{ loop.index }}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">Status: Pending</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-span-3 text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-3"></i>
                        <p>Command queue is empty</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>eSSL Multi-Device Monitor • v2.2 • Full Attendance Logs Support</p>
            <p class="mt-1 text-xs">
                <span class="{% if device_connected %}text-green-600{% else %}text-red-600{% endif %}">●</span> Device: {{ "Connected" if device_connected else "Disconnected" }} | 
                <span class="text-blue-600">●</span> Total Records: {{ total_records }} | 
                <span class="text-purple-600">●</span> Today: {{ today_records }} |
                Last update: <span id="lastUpdateTime">{{ current_time }}</span>
            </p>
        </footer>
    </div>

    <!-- Device Details Modal -->
    <div id="deviceModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white">Device Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 overflow-auto flex-1">
                <div class="raw-data-container" id="modalContent">
                    <div class="text-white">
                        <h4 class="text-lg font-bold mb-4">Device Information</h4>
                        <div class="space-y-3">
                            <div><strong>Serial Number:</strong> {{ device_sn }}</div>
                            <div><strong>Status:</strong> {{ "Connected" if device_connected else "Disconnected" }}</div>
                            <div><strong>Last Contact:</strong> {{ last_contact }}</div>
                            <div><strong>Total Records:</strong> {{ total_records }}</div>
                            <div><strong>Unique Users:</strong> {{ unique_users }}</div>
                            <div><strong>Today's Records:</strong> {{ today_records }}</div>
                            <div><strong>Command Queue:</strong> {{ queue|length }} commands</div>
                        </div>
                        
                        <h4 class="text-lg font-bold mt-6 mb-4">Device Info Parameters</h4>
                        <div class="space-y-2">
                            {% for key, value in device_info.items() %}
                            <div><strong>{{ key }}:</strong> {{ value }}</div>
                            {% else %}
                            <div class="text-gray-400">No device info parameters available</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-end">
                <button onclick="closeModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let autoRefreshInterval;
        let refreshCountdown = 30;
        let isAutoRefresh = true;

        // Show notification
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(el => el.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                       type === 'error' ? 'exclamation-circle' : 
                                       type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Force fetch all logs
        async function forceFetchAll() {
            if (!confirm('Force fetch ALL attendance logs from device? This will send multiple commands.')) return;
            
            try {
                showNotification('Initiating force fetch ALL logs...', 'info');
                
                const response = await fetch('/force_fetch_all');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                showNotification('Force fetch initiated. Check logs for progress.', 'success');
                setTimeout(refreshData, 2000);
                
            } catch (error) {
                console.error('Error force fetching:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Send command
        async function sendCommand(command) {
            try {
                showNotification(`Sending command: ${command}`, 'info');
                
                const formData = new FormData();
                formData.append('endpoint', '/iclock/getrequest.aspx');
                formData.append('command', command);
                
                const response = await fetch('/send_command', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                showNotification(`Command queued: ${command}`, 'success');
                setTimeout(refreshData, 1000);
                
            } catch (error) {
                console.error('Error sending command:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Send manual command
        async function sendManualCommand() {
            const command = document.getElementById('manualCommand').value;
            if (!command) {
                showNotification('Please select a command', 'warning');
                return;
            }
            
            await sendCommand(command);
        }

        // View device details
        function viewDeviceDetails() {
            document.getElementById('deviceModal').classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('deviceModal').classList.add('hidden');
        }

        // Clear logs
        async function clearLogs() {
            if (!confirm('Clear all system logs?')) return;
            
            try {
                const response = await fetch('/clear_logs', { method: 'POST' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                showNotification('Logs cleared', 'success');
                setTimeout(refreshData, 1000);
                
            } catch (error) {
                console.error('Error clearing logs:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Clear attendance
        async function clearAttendance() {
            if (!confirm('Clear ALL attendance data? This cannot be undone.')) return;
            
            try {
                const response = await fetch('/clear_attendance', { method: 'POST' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                showNotification('Attendance data cleared', 'success');
                setTimeout(refreshData, 1000);
                
            } catch (error) {
                console.error('Error clearing attendance:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Clear queue
        async function clearQueue() {
            if (!confirm('Clear command queue?')) return;
            
            try {
                const response = await fetch('/clear_queue', { method: 'POST' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                showNotification('Command queue cleared', 'success');
                setTimeout(refreshData, 1000);
                
            } catch (error) {
                console.error('Error clearing queue:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Export logs
        async function exportLogs() {
            try {
                window.open('/export_attendance?format=csv', '_blank');
                showNotification('Exporting attendance data...', 'info');
            } catch (error) {
                console.error('Error exporting:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Export attendance
        async function exportAttendance() {
            try {
                window.open('/export_attendance?format=csv', '_blank');
                showNotification('Exporting attendance data...', 'info');
            } catch (error) {
                console.error('Error exporting:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Refresh data
        async function refreshData() {
            try {
                const response = await fetch('/get_logs');
                const data = await response.json();
                
                // Update logs
                const logContainer = document.getElementById('logContainer');
                if (logContainer && data.logs) {
                    const logs = data.logs.slice(-100).reverse();
                    logContainer.innerHTML = logs.map(log => `
                        <div class="data-line">
                            <div class="text-xs text-gray-500 mb-1">${log.slice(0, 24)}</div>
                            <div class="text-green-400">${log.slice(24)}</div>
                        </div>
                    `).join('');
                    logContainer.scrollTop = 0;
                }
                
                // Update attendance
                const attendanceTable = document.getElementById('attendanceTable');
                if (attendanceTable && data.attendance) {
                    if (data.attendance.length > 0) {
                        const attendanceHtml = data.attendance.map(line => {
                            const parts = line.split('\t');
                            if (parts.length >= 3) {
                                let statusBadge = '';
                                if (parts[2] === '0') {
                                    statusBadge = '<span class="status-badge status-checkin">Check-in</span>';
                                } else if (parts[2] === '1') {
                                    statusBadge = '<span class="status-badge status-checkout">Check-out</span>';
                                } else if (parts[2] === '2') {
                                    statusBadge = '<span class="status-badge status-breakout">Break-out</span>';
                                } else if (parts[2] === '3') {
                                    statusBadge = '<span class="status-badge status-breakin">Break-in</span>';
                                } else {
                                    statusBadge = `<span class="status-badge status-other">Code ${parts[2]}</span>`;
                                }
                                
                                const date = parts[1].length >= 10 ? parts[1].slice(0, 10) : parts[1];
                                const time = parts[1].length > 10 ? parts[1].slice(11) : '';
                                
                                return `
                                    <tr class="hover:bg-gray-50 ${parts[2] === '1' ? 'bg-red-50' : parts[2] === '0' ? 'bg-green-50' : ''}">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-bold text-gray-900">${parts[0]}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900 font-medium">${date}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-bold text-gray-900">${time}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            ${statusBadge}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ${parts[3] || ''}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ${parts[4] || ''}
                                        </td>
                                    </tr>
                                `;
                            }
                            return '';
                        }).join('');
                        
                        attendanceTable.innerHTML = attendanceHtml;
                    } else {
                        attendanceTable.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                    <i class="fas fa-inbox text-4xl mb-4 text-gray-400"></i>
                                    <p class="font-medium text-lg mb-2">No attendance records yet</p>
                                    <p class="text-sm mb-4">Fetch data from device using Quick Actions</p>
                                    <button onclick="sendCommand('GET ATTLOG ALL')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center mx-auto">
                                        <i class="fas fa-download mr-2"></i>Fetch Attendance Data
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                }
                
                // Update queue
                const queueContainer = document.getElementById('queueContainer');
                if (queueContainer && data.queue) {
                    if (data.queue.length > 0) {
                        const queueHtml = data.queue.map((cmd, index) => `
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="flex justify-between items-start">
                                    <div class="font-medium text-gray-800">${cmd}</div>
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${index + 1}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">Status: Pending</div>
                            </div>
                        `).join('');
                        queueContainer.innerHTML = queueHtml;
                    } else {
                        queueContainer.innerHTML = `
                            <div class="col-span-3 text-center py-8 text-gray-500">
                                <i class="fas fa-inbox text-3xl mb-3"></i>
                                <p>Command queue is empty</p>
                            </div>
                        `;
                    }
                }
                
                // Update counters
                document.getElementById('totalRecords').textContent = data.attendance_count;
                document.getElementById('todayRecords').textContent = data.today_count;
                document.getElementById('uniqueUsers').textContent = data.unique_users;
                document.getElementById('queueCount').textContent = data.queue_count;
                document.getElementById('deviceSn').textContent = data.device_sn || 'Not detected';
                
                // Update last update time
                const now = new Date();
                document.getElementById('lastUpdateTime').textContent = now.toLocaleString();
                
                // Update status indicator
                const statusIndicator = document.querySelector('.device-status');
                if (statusIndicator) {
                    if (data.device_connected) {
                        statusIndicator.className = 'device-status status-online blink';
                        document.querySelector('.device-card').classList.add('device-active');
                        document.querySelector('.device-card').classList.remove('device-inactive');
                    } else {
                        statusIndicator.className = 'device-status status-offline';
                        document.querySelector('.device-card').classList.remove('device-active');
                        document.querySelector('.device-card').classList.add('device-inactive');
                    }
                }
                
                showNotification('Data refreshed', 'success');
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Error refreshing data', 'error');
            }
        }

        // Refresh attendance (alias for refreshData)
        function refreshAttendance() {
            refreshData();
        }

        // Initialize auto-refresh
        function initAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            if (isAutoRefresh) {
                refreshCountdown = 30;
                autoRefreshInterval = setInterval(() => {
                    refreshCountdown--;
                    document.getElementById('refreshCount').textContent = refreshCountdown;
                    
                    if (refreshCountdown <= 0) {
                        refreshData();
                        refreshCountdown = 30;
                    }
                }, 1000);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initAutoRefresh();
            refreshData();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshData, 30000);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    refreshData();
                }
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>