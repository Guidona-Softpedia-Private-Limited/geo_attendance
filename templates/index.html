<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eSSL Multi-Device Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .device-card {
            border-left: 4px solid;
            transition: all 0.3s;
        }
        .device-active {
            border-left-color: #10b981;
        }
        .device-inactive {
            border-left-color: #ef4444;
            opacity: 0.7;
        }
        .raw-data-container {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #f0f0f0;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 12px;
            border: 1px solid #333;
        }
        .data-line {
            border-bottom: 1px solid #2d2d2d;
            padding: 4px 0;
            margin: 2px 0;
        }
        .data-line:hover {
            background: #2d2d2d;
        }
        .hex-view {
            color: #4ade80;
        }
        .ascii-view {
            color: #60a5fa;
        }
        .tab-button {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-button.active {
            background: #3b82f6;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .device-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }
        .status-offline {
            background: #ef4444;
        }
        .blink {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .log-timestamp {
            color: #9ca3af;
            font-family: monospace;
            font-size: 11px;
            min-width: 140px;
        }
        .log-message {
            word-break: break-word;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-satellite-dish mr-3 text-blue-600"></i>
                eSSL Multi-Device Monitor
            </h1>
            <p class="text-gray-600 mb-6">Real-time monitoring for multiple biometric devices</p>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="text-2xl font-bold text-blue-600">{{ devices|length }}</div>
                    <div class="text-sm text-gray-600">Devices Detected</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="text-2xl font-bold text-green-600">{{ total_records }}</div>
                    <div class="text-sm text-gray-600">Total Records</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="text-2xl font-bold text-purple-600">{{ live_records }}</div>
                    <div class="text-sm text-gray-600">Today's Records</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="text-2xl font-bold text-orange-600">{{ total_data_size }}</div>
                    <div class="text-sm text-gray-600">Data Received</div>
                </div>
            </div>
        </header>

        <!-- DEVICES SECTION -->
        <div class="card mb-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-microchip mr-2 text-blue-600"></i>
                        Connected Devices
                    </h2>
                    <div class="text-sm text-gray-600 mt-1">
                        <span class="text-green-600"><i class="fas fa-circle text-xs mr-1"></i>{{ online_devices }} online</span>
                        <span class="ml-4 text-gray-500"><i class="fas fa-clock mr-1"></i>Updated: {{ last_update_time }}</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="rescanDevices()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Rescan Devices
                    </button>
                    <button onclick="sendCommandToAll('GET OPTION')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                        <i class="fas fa-broadcast-tower mr-2"></i>Broadcast
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {% for device in devices %}
                <div class="device-card {% if device.last_seen_seconds < 300 %}device-active{% else %}device-inactive{% endif %} p-4 bg-white rounded-lg shadow border border-gray-200">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800 mb-1">
                                <span class="device-status {% if device.last_seen_seconds < 300 %}status-online blink{% else %}status-offline{% endif %}"></span>
                                Device: {{ device.sn }}
                            </h3>
                            <div class="text-sm text-gray-600">
                                <span class="inline-block mr-4"><i class="fas fa-calendar mr-1"></i>{{ device.first_seen }}</span>
                                <span class="inline-block"><i class="fas fa-clock mr-1"></i>{{ device.last_seen }}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium {% if device.last_seen_seconds < 300 %}text-green-600{% else %}text-red-600{% endif %}">
                                {% if device.last_seen_seconds < 60 %}
                                    Just now
                                {% elif device.last_seen_seconds < 300 %}
                                    {{ (device.last_seen_seconds/60)|int }} min ago
                                {% else %}
                                    {{ (device.last_seen_seconds/3600)|int }} hours ago
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Status</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500 mb-1">Records</div>
                            <div class="text-lg font-bold text-blue-600">{{ device.records_count }}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500 mb-1">Communications</div>
                            <div class="text-lg font-bold text-purple-600">{{ device.comms_count }}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500 mb-1">IP Address</div>
                            <div class="text-lg font-bold text-gray-800">{{ device.ip_address }}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500 mb-1">Device Name</div>
                            <div class="text-lg font-bold text-gray-800">{{ device.device_name }}</div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="sendDeviceCommand('{{ device.sn }}', 'GET ATTLOG')" 
                                class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded text-sm flex items-center justify-center">
                            <i class="fas fa-download mr-2"></i>Get Data
                        </button>
                        <button onclick="viewDeviceDetails('{{ device.sn }}')" 
                                class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm flex items-center justify-center">
                            <i class="fas fa-info-circle mr-2"></i>Details
                        </button>
                        <button onclick="viewDeviceRawData('{{ device.sn }}')" 
                                class="flex-1 bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded text-sm flex items-center justify-center">
                            <i class="fas fa-code mr-2"></i>Raw Data
                        </button>
                    </div>
                </div>
                {% endfor %}
                
                {% if devices|length < 2 %}
                <div class="device-card device-inactive p-4 bg-gray-50 rounded-lg shadow-inner border border-dashed border-gray-300 flex flex-col items-center justify-center text-center">
                    <i class="fas fa-question-circle text-4xl text-gray-400 mb-4"></i>
                    <h3 class="font-bold text-lg text-gray-600 mb-2">Second Device Not Detected</h3>
                    <p class="text-gray-500 text-sm mb-4">Waiting for second device to connect...</p>
                    <div class="text-xs text-gray-400">
                        <p>Check device configuration:</p>
                        <p class="mt-1">1. Device IP settings</p>
                        <p>2. Network connectivity</p>
                        <p>3. Server URL configuration</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- RAW DATA MONITOR -->
            <div class="card lg:col-span-2">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-code mr-2 text-green-600"></i>
                            Raw Data Monitor
                        </h2>
                        <div class="text-sm text-gray-600 mt-1">Complete raw body from device communications</div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button onclick="setDataView('hex')" id="hexTab" class="tab-button active">Hex</button>
                            <button onclick="setDataView('ascii')" id="asciiTab" class="tab-button">ASCII</button>
                            <button onclick="setDataView('raw')" id="rawTab" class="tab-button">Raw</button>
                        </div>
                        <button onclick="clearRawData()" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded text-sm">
                            <i class="fas fa-trash mr-2"></i>Clear
                        </button>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span id="currentDevice">All Devices</span>
                        <span id="dataStats">0 bytes, 0 lines</span>
                    </div>
                    <div class="raw-data-container" id="rawDataContainer">
                        {% if recent_raw_data %}
                            {% for data in recent_raw_data %}
                            <div class="data-line">
                                <div class="text-xs text-gray-500 mb-1">
                                    [{{ data.timestamp }}] {{ data.device_sn }} ({{ data.length }} bytes)
                                </div>
                                <div class="hex-view">
                                    {{ data.hex_preview }}
                                </div>
                                <div class="ascii-view mt-1">
                                    {{ data.ascii_preview }}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-gray-500 text-center py-8">
                                <i class="fas fa-database text-3xl mb-3"></i>
                                <p>No raw data received yet</p>
                                <p class="text-sm mt-1">Waiting for device communications...</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-4 text-center">
                    <div class="bg-blue-50 p-3 rounded">
                        <div class="text-lg font-bold text-blue-600" id="totalBytes">{{ total_data_bytes }}</div>
                        <div class="text-xs text-blue-500">Total Bytes</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded">
                        <div class="text-lg font-bold text-green-600" id="totalComms">{{ total_comms }}</div>
                        <div class="text-xs text-green-500">Communications</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded">
                        <div class="text-lg font-bold text-purple-600" id="lastComms">0</div>
                        <div class="text-xs text-purple-500">Last 5 min</div>
                    </div>
                    <div class="bg-orange-50 p-3 rounded">
                        <div class="text-lg font-bold text-orange-600" id="dataRate">0/s</div>
                        <div class="text-xs text-orange-500">Data Rate</div>
                    </div>
                </div>
            </div>

            <!-- QUICK ACTIONS -->
            <div class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-bolt mr-2 text-yellow-600"></i>
                    Quick Actions
                </h2>
                
                <div class="space-y-3">
                    <button onclick="fetchAllDevices()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg flex items-center justify-between transition-colors">
                        <span>Fetch All Devices Data</span>
                        <i class="fas fa-download"></i>
                    </button>
                    
                    <button onclick="sendCommandToAll('GET OPTION')" class="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg flex items-center justify-between transition-colors">
                        <span>Get All Device Info</span>
                        <i class="fas fa-info-circle"></i>
                    </button>
                    
                    <button onclick="sendCommandToAll('GET ATTLOG')" class="w-full bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg flex items-center justify-between transition-colors">
                        <span>Get Live Attendance</span>
                        <i class="fas fa-user-clock"></i>
                    </button>
                    
                    <button onclick="sendCommandToAll('REBOOT')" class="w-full bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg flex items-center justify-between transition-colors">
                        <span>Reboot All Devices</span>
                        <i class="fas fa-power-off"></i>
                    </button>
                    
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium text-gray-700 mb-3">Manual Command</h3>
                        <div class="flex gap-2">
                            <input type="text" id="manualCommand" placeholder="e.g., GET ATTLOG ALL" 
                                   class="flex-1 p-2 border border-gray-300 rounded text-sm" value="GET ATTLOG">
                            <button onclick="sendManualCommand()" class="bg-blue-600 text-white p-2 rounded">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="mt-2 text-xs text-gray-500">
                            <p>Commands: GET ATTLOG, GET OPTION, DATA, CLEAR DATA, REBOOT</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ATTENDANCE RECORDS -->
        <div class="card mt-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-history mr-2 text-purple-600"></i>
                        Recent Attendance Records
                    </h2>
                    <div class="text-sm text-gray-600 mt-1">Latest 50 records from all devices</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="refreshAttendance()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Verification</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Workcode</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Raw Data</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="attendanceTable">
                        {% if recent_attendance %}
                            {% for record in recent_attendance %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                                            <span class="text-xs font-bold text-blue-600">{{ record.device_sn|last(4) }}</span>
                                        </div>
                                        <div class="ml-3">
                                            <div class="text-sm font-medium text-gray-900">{{ record.device_name }}</div>
                                            <div class="text-xs text-gray-500">{{ record.device_sn }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-bold text-gray-900">{{ record.user_id }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ record.display_time }}</div>
                                    <div class="text-xs text-gray-500">{{ record.display_date }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                        {% if record.status == '0' %}bg-green-100 text-green-800
                                        {% elif record.status == '1' %}bg-red-100 text-red-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ record.status_text }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ record.verification }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ record.workcode }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <button onclick="viewRecordRawData('{{ record.raw_data_hash }}')" class="text-blue-600 hover:text-blue-900 text-sm">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                    <i class="fas fa-inbox text-3xl mb-3"></i>
                                    <p class="font-medium">No attendance records yet</p>
                                    <p class="text-sm mt-1">Fetch data from devices using Quick Actions</p>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SYSTEM LOGS -->
        <div class="card mt-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-terminal mr-2 text-gray-600"></i>
                        System Logs
                    </h2>
                    <div class="text-sm text-gray-600 mt-1">All system activities and device communications</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="refreshLogs()" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                        <i class="fas fa-redo mr-1"></i> Refresh
                    </button>
                    <button onclick="exportLogs()" class="text-sm text-green-600 hover:text-green-800 flex items-center">
                        <i class="fas fa-download mr-1"></i> Export
                    </button>
                    <button onclick="clearLogs()" class="text-sm text-red-600 hover:text-red-800 flex items-center">
                        <i class="fas fa-trash mr-1"></i> Clear
                    </button>
                </div>
            </div>
            
            <div class="bg-gray-900 text-gray-300 font-mono text-sm rounded-lg p-4 max-h-64 overflow-y-auto" id="logPanel">
                {% for log in logs %}
                <div class="mb-1 border-b border-gray-800 pb-1 flex">
                    <span class="log-timestamp">{{ log.split(']')[0] }}]</span>
                    <span class="log-message flex-1">{{ log.split(']')[1] }}</span>
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-4 text-xs text-gray-500">
                <p>Listening on: <span class="font-mono text-blue-400">{{ server_url }}</span></p>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>eSSL Multi-Device Monitor • v2.1 • Supports multiple biometric devices</p>
            <p class="mt-1 text-xs">
                <span class="text-green-600">●</span> Active Devices: {{ online_devices }} | 
                <span class="text-blue-600">●</span> Total Communications: {{ total_comms }} | 
                Last update: <span id="lastUpdateTime">{{ now.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </p>
        </footer>
    </div>

    <!-- Raw Data Modal -->
    <div id="rawDataModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white" id="modalTitle">Raw Data</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 overflow-auto flex-1">
                <div class="raw-data-container" id="modalRawData"></div>
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-between">
                <div class="text-sm text-gray-400" id="modalStats"></div>
                <button onclick="copyRawData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                    <i class="fas fa-copy mr-2"></i>Copy to Clipboard
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentDataView = 'hex';
        let currentDeviceFilter = 'all';
        let dataRateHistory = [];

        // Set data view mode
        function setDataView(mode) {
            currentDataView = mode;
            
            // Update tab buttons
            document.getElementById('hexTab').classList.toggle('active', mode === 'hex');
            document.getElementById('asciiTab').classList.toggle('active', mode === 'ascii');
            document.getElementById('rawTab').classList.toggle('active', mode === 'raw');
            
            // Refresh data display
            refreshRawData();
        }

        // Send command to specific device
        async function sendDeviceCommand(deviceSn, command) {
            try {
                const response = await fetch(`/api/device/${deviceSn}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `command=${encodeURIComponent(command)}`
                });
                
                const result = await response.json();
                showNotification(`Command sent to ${deviceSn}: ${result.command}`, 'success');
                
            } catch (error) {
                showNotification(`Error sending command: ${error.message}`, 'error');
            }
        }

        // Send command to all devices
        async function sendCommandToAll(command) {
            if (!confirm(`Send "${command}" to all devices?`)) return;
            
            try {
                const response = await fetch('/api/command/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `command=${encodeURIComponent(command)}`
                });
                
                const result = await response.json();
                showNotification(`Command broadcasted to ${result.devices_count} devices`, 'success');
                
            } catch (error) {
                showNotification(`Error broadcasting command: ${error.message}`, 'error');
            }
        }

        // Send manual command
        async function sendManualCommand() {
            const command = document.getElementById('manualCommand').value.trim();
            if (!command) {
                showNotification('Please enter a command', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/command/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `command=${encodeURIComponent(command)}`
                });
                
                const result = await response.json();
                showNotification(`Command queued: ${result.command}`, 'success');
                document.getElementById('manualCommand').value = '';
                
            } catch (error) {
                showNotification(`Error sending command: ${error.message}`, 'error');
            }
        }

        // View device details
        async function viewDeviceDetails(deviceSn) {
            try {
                const response = await fetch(`/api/device/${deviceSn}`);
                const device = await response.json();
                
                const modal = document.getElementById('rawDataModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalData = document.getElementById('modalRawData');
                const modalStats = document.getElementById('modalStats');
                
                let details = `Device: ${device.sn}\n`;
                details += `Status: ${device.last_seen_seconds < 300 ? 'Online' : 'Offline'}\n`;
                details += `Last Seen: ${device.last_seen}\n`;
                details += `First Seen: ${device.first_seen}\n`;
                details += `IP Address: ${device.ip_address}\n`;
                details += `Device Name: ${device.device_name}\n`;
                details += `Records: ${device.records_count}\n`;
                details += `Communications: ${device.comms_count}\n`;
                details += `\n=== Device Parameters ===\n`;
                
                for (const [key, value] of Object.entries(device.params || {})) {
                    details += `${key}: ${value}\n`;
                }
                
                modalTitle.textContent = `Device Details: ${device.sn}`;
                modalData.textContent = details;
                modalStats.textContent = `${device.sn} • ${device.records_count} records • ${device.comms_count} comms`;
                modal.classList.remove('hidden');
                
            } catch (error) {
                showNotification(`Error loading device details: ${error.message}`, 'error');
            }
        }

        // View device raw data
        async function viewDeviceRawData(deviceSn) {
            try {
                const response = await fetch(`/api/device/${deviceSn}/raw-data`);
                const data = await response.json();
                
                const modal = document.getElementById('rawDataModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalData = document.getElementById('modalRawData');
                const modalStats = document.getElementById('modalStats');
                
                modalTitle.textContent = `Raw Data: ${deviceSn}`;
                modalData.textContent = formatRawData(data.raw_data, 'raw');
                modalStats.textContent = `${deviceSn} • ${data.count} communications • ${data.total_bytes} bytes`;
                modal.classList.remove('hidden');
                
            } catch (error) {
                showNotification(`Error loading raw data: ${error.message}`, 'error');
            }
        }

        // View record raw data
        async function viewRecordRawData(dataHash) {
            try {
                const response = await fetch(`/api/raw-data/${dataHash}`);
                const data = await response.json();
                
                const modal = document.getElementById('rawDataModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalData = document.getElementById('modalRawData');
                const modalStats = document.getElementById('modalStats');
                
                modalTitle.textContent = 'Record Raw Data';
                modalData.textContent = data.raw_data;
                modalStats.textContent = `Hash: ${data.hash} • ${data.length} bytes • ${data.timestamp}`;
                modal.classList.remove('hidden');
                
            } catch (error) {
                showNotification(`Error loading raw data: ${error.message}`, 'error');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('rawDataModal').classList.add('hidden');
        }

        // Copy raw data to clipboard
        async function copyRawData() {
            const data = document.getElementById('modalRawData').textContent;
            try {
                await navigator.clipboard.writeText(data);
                showNotification('Raw data copied to clipboard', 'success');
            } catch (error) {
                showNotification('Failed to copy to clipboard', 'error');
            }
        }

        // Refresh raw data display
        async function refreshRawData() {
            try {
                const response = await fetch('/api/raw-data/recent');
                const data = await response.json();
                
                const container = document.getElementById('rawDataContainer');
                const stats = document.getElementById('dataStats');
                
                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-database text-3xl mb-3"></i>
                            <p>No raw data received yet</p>
                            <p class="text-sm mt-1">Waiting for device communications...</p>
                        </div>
                    `;
                    stats.textContent = '0 bytes, 0 lines';
                    return;
                }
                
                let html = '';
                data.forEach(item => {
                    html += `
                        <div class="data-line">
                            <div class="text-xs text-gray-500 mb-1">
                                [${item.timestamp}] ${item.device_sn} (${item.length} bytes)
                            </div>
                            <div class="${currentDataView}-view">
                                ${formatRawData(item.raw_data, currentDataView)}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                stats.textContent = `${data.reduce((a, b) => a + b.length, 0)} bytes, ${data.length} lines`;
                
            } catch (error) {
                console.error('Error refreshing raw data:', error);
            }
        }

        // Format raw data for display
        function formatRawData(data, mode) {
            if (!data) return '';
            
            switch(mode) {
                case 'hex':
                    return data.split('').map(c => 
                        c.charCodeAt(0).toString(16).padStart(2, '0')
                    ).join(' ');
                    
                case 'ascii':
                    return data.replace(/[^\x20-\x7E]/g, '.');
                    
                case 'raw':
                default:
                    return data;
            }
        }

        // Clear raw data
        async function clearRawData() {
            if (!confirm('Clear raw data display? This does not delete stored data.')) return;
            
            document.getElementById('rawDataContainer').innerHTML = `
                <div class="text-gray-500 text-center py-8">
                    <i class="fas fa-database text-3xl mb-3"></i>
                    <p>Raw data cleared</p>
                    <p class="text-sm mt-1">Waiting for new device communications...</p>
                </div>
            `;
        }

        // Rescan devices
        async function rescanDevices() {
            try {
                const response = await fetch('/api/devices/rescan', { method: 'POST' });
                const result = await response.json();
                
                showNotification(`Rescanned devices: ${result.devices_count} found`, 'success');
                setTimeout(() => location.reload(), 1000);
                
            } catch (error) {
                showNotification(`Error rescanning devices: ${error.message}`, 'error');
            }
        }

        // Fetch all devices data
        async function fetchAllDevices() {
            if (!confirm('Fetch data from all devices? This may take a moment.')) return;
            
            try {
                const response = await fetch('/api/fetch/all', { method: 'POST' });
                const result = await response.json();
                
                showNotification(`Fetch initiated for ${result.devices_count} devices`, 'success');
                
            } catch (error) {
                showNotification(`Error fetching devices: ${error.message}`, 'error');
            }
        }

        // Refresh attendance
        async function refreshAttendance() {
            try {
                const response = await fetch('/api/attendance/recent');
                const data = await response.json();
                
                const table = document.getElementById('attendanceTable');
                
                if (data.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                <i class="fas fa-inbox text-3xl mb-3"></i>
                                <p class="font-medium">No attendance records yet</p>
                                <p class="text-sm mt-1">Fetch data from devices using Quick Actions</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                data.forEach(record => {
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                                        <span class="text-xs font-bold text-blue-600">${record.device_sn.slice(-4)}</span>
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900">${record.device_name}</div>
                                        <div class="text-xs text-gray-500">${record.device_sn}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-bold text-gray-900">${record.user_id}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${record.display_time}</div>
                                <div class="text-xs text-gray-500">${record.display_date}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    ${record.status === '0' ? 'bg-green-100 text-green-800' : 
                                      record.status === '1' ? 'bg-red-100 text-red-800' : 
                                      'bg-gray-100 text-gray-800'}">
                                    ${record.status_text}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${record.verification || ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${record.workcode || ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button onclick="viewRecordRawData('${record.raw_data_hash}')" class="text-blue-600 hover:text-blue-900 text-sm">
                                    <i class="fas fa-eye mr-1"></i>View
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                table.innerHTML = html;
                showNotification('Attendance refreshed', 'success');
                
            } catch (error) {
                showNotification(`Error refreshing attendance: ${error.message}`, 'error');
            }
        }

        // Refresh logs
        async function refreshLogs() {
            try {
                const response = await fetch('/api/logs/recent');
                const logs = await response.json();
                
                const logPanel = document.getElementById('logPanel');
                let html = '';
                
                logs.forEach(log => {
                    html += `
                        <div class="mb-1 border-b border-gray-800 pb-1 flex">
                            <span class="log-timestamp">${log.split(']')[0]}]</span>
                            <span class="log-message flex-1">${log.split(']')[1]}</span>
                        </div>
                    `;
                });
                
                logPanel.innerHTML = html;
                logPanel.scrollTop = logPanel.scrollHeight;
                
            } catch (error) {
                console.error('Error refreshing logs:', error);
            }
        }

        // Export logs
        async function exportLogs() {
            try {
                const response = await fetch('/api/logs/export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `essl_logs_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                showNotification(`Error exporting logs: ${error.message}`, 'error');
            }
        }

        // Clear logs
        async function clearLogs() {
            if (!confirm('Clear all system logs?')) return;
            
            try {
                const response = await fetch('/api/logs/clear', { method: 'DELETE' });
                const result = await response.json();
                
                showNotification(result.message, 'success');
                setTimeout(refreshLogs, 1000);
                
            } catch (error) {
                showNotification(`Error clearing logs: ${error.message}`, 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                type === 'warning' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                       type === 'error' ? 'exclamation-circle' : 
                                       type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdateTime').textContent = 
                `${now.toLocaleDateString()} ${timeString}`;
        }

        // Auto-refresh functions
        setInterval(refreshRawData, 5000);
        setInterval(refreshLogs, 5000);
        setInterval(updateLastUpdateTime, 60000);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateLastUpdateTime();
            
            // Auto-scroll logs to bottom
            const logPanel = document.getElementById('logPanel');
            if (logPanel) {
                logPanel.scrollTop = logPanel.scrollHeight;
            }
            
            // Auto-scroll raw data to bottom
            const rawDataContainer = document.getElementById('rawDataContainer');
            if (rawDataContainer) {
                rawDataContainer.scrollTop = rawDataContainer.scrollHeight;
            }
        });
    </script>
</body>
</html>