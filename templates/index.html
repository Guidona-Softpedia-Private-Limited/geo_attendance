<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>eSSL Probe UI</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        font-family: 'Inter', sans-serif;
        background: radial-gradient(circle at top, #0f2027, #000);
        color: #e5e7eb;
    }

    h1 {
        text-align: center;
        font-weight: 600;
        margin: 30px 0;
        color: #22d3ee;
        letter-spacing: 1px;
    }

    .container {
        max-width: 1300px;
        margin: auto;
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .card {
        background: rgba(255, 255, 255, 0.06);
        backdrop-filter: blur(12px);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 0 40px rgba(34, 211, 238, 0.08);
        border: 1px solid rgba(255,255,255,0.08);
    }

    h2 {
        margin-top: 0;
        font-weight: 500;
        color: #38bdf8;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    form {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    label {
        font-size: 14px;
        opacity: 0.85;
    }

    select, button {
        background: #020617;
        color: #e5e7eb;
        border: 1px solid rgba(255,255,255,0.15);
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 14px;
        outline: none;
    }

    select:hover, button:hover {
        border-color: #22d3ee;
    }

    button {
        cursor: pointer;
        background: linear-gradient(135deg, #22d3ee, #3b82f6);
        color: #020617;
        font-weight: 600;
        transition: transform 0.2s ease;
        border: none;
    }

    button:hover {
        transform: scale(1.05);
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn-red {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .btn-green {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .btn-blue {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
    }

    .logs {
        background: #020617;
        border-radius: 14px;
        padding: 15px;
        height: 420px;
        overflow-y: auto;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
    }

    .log-line {
        color: #22c55e;
        white-space: pre-wrap;
        margin-bottom: 5px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        padding-bottom: 5px;
    }

    .att-line {
        color: #fbbf24;
        white-space: pre-wrap;
        margin-bottom: 5px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        padding-bottom: 5px;
    }

    .queue-item {
        background: rgba(34, 211, 238, 0.1);
        padding: 8px 12px;
        margin: 5px 0;
        border-radius: 8px;
        border-left: 3px solid #22d3ee;
    }

    footer {
        text-align: center;
        font-size: 12px;
        opacity: 0.5;
        margin-top: 25px;
        grid-column: 1 / -1;
    }

    .command-queue {
        background: rgba(34, 211, 238, 0.05);
        padding: 15px;
        border-radius: 10px;
        margin-top: 10px;
        max-height: 150px;
        overflow-y: auto;
    }

    .empty-queue {
        color: rgba(255,255,255,0.3);
        font-style: italic;
        text-align: center;
        padding: 20px;
    }

    .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        padding: 10px;
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
        flex-wrap: wrap;
    }

    .stat-item {
        text-align: center;
        flex: 1;
        min-width: 80px;
    }

    .stat-value {
        font-size: 20px;
        font-weight: bold;
        color: #22d3ee;
    }

    .stat-label {
        font-size: 11px;
        opacity: 0.7;
    }

    .device-info {
        background: rgba(34, 211, 238, 0.1);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #22d3ee;
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-online {
        background-color: #10b981;
        box-shadow: 0 0 10px #10b981;
    }

    .status-offline {
        background-color: #ef4444;
    }

    .refresh-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 15px;
        padding: 10px;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
    }
</style>
</head>

<body>

<h1>‚ö° eSSL Probe Dashboard</h1>

<div class="container">

    <!-- Left Column -->
    <div>
        <!-- Device Info -->
        <div class="card">
            <h2>Device Status</h2>
            <div class="device-info">
                <div><span class="status-indicator status-online" id="statusIndicator"></span> Server: <strong>Running</strong></div>
                <div>Device SN: <strong id="deviceSn">{% if device_sn %}{{device_sn}}{% else %}Not detected yet{% endif %}</strong></div>
                <div>Last Update: <strong id="lastUpdate">{{datetime.utcnow().isoformat()}}Z</strong></div>
            </div>
            
            <!-- Manual Command -->
            <div class="card-header">
                <h3>Send Manual Command</h3>
                <div style="display: flex; gap: 10px;">
                    <form method="post" action="/clear_queue" style="margin: 0;">
                        <button type="submit" class="btn-small btn-red">Clear Queue</button>
                    </form>
                    <form method="post" action="/clear_logs" style="margin: 0;">
                        <button type="submit" class="btn-small btn-red">Clear All Logs</button>
                    </form>
                    <a href="/export_attendance" target="_blank">
                        <button class="btn-small btn-green">Export</button>
                    </a>
                </div>
            </div>
            
            <form method="post" action="/send_command">
                <label>Endpoint</label>
                <select name="endpoint">
                    {% for ep in endpoints %}
                    <option value="{{ep}}">{{ep}}</option>
                    {% endfor %}
                </select>

                <label>Command</label>
                <select name="command">
                    {% for cmd in commands %}
                    <option value="{{cmd}}">{{cmd}}</option>
                    {% endfor %}
                </select>

                <button type="submit">Send</button>
            </form>

            <!-- Command Queue -->
            <div style="margin-top: 20px;">
                <h3>Command Queue (<span id="queueCount">{{ queue|length }}</span>)</h3>
                <div class="command-queue" id="commandQueue">
                    {% if queue %}
                        {% for cmd in queue %}
                        <div class="queue-item">{{ cmd }}</div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-queue">No commands in queue</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Device Logs -->
        <div class="card">
            <h2>Device Communication Logs (<span id="logsCount">{{ logs|length }}</span>)</h2>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="logsCountValue">{{ logs|length }}</div>
                    <div class="stat-label">Log Entries</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="attendanceCount">{{ attendance|length }}</div>
                    <div class="stat-label">Attendance</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="queueCountValue">{{ queue|length }}</div>
                    <div class="stat-label">Queued</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="lastUpdateTime">Now</div>
                    <div class="stat-label">Last Update</div>
                </div>
            </div>
            
            <div class="refresh-controls">
                <button class="btn-small btn-blue" onclick="refreshData()">üîÑ Refresh Now</button>
                <label style="font-size: 12px;">
                    <input type="checkbox" id="autoRefresh" checked> Auto-refresh every 10s
                </label>
                <div style="margin-left: auto; font-size: 11px; opacity: 0.7;">
                    <span id="nextRefresh">Next: 10s</span>
                </div>
            </div>
            
            <div class="logs" id="logBox">
                {% for line in logs %}
                <div class="log-line">{{line}}</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div>
        <!-- Attendance Data -->
        <div class="card">
            <h2>Attendance Data (<span id="attendanceCountValue">{{ attendance|length }}</span> records)</h2>
            <div class="logs" id="attBox">
                {% if attendance %}
                    {% for line in attendance %}
                    <div class="att-line">{{line}}</div>
                    {% endfor %}
                {% else %}
                    <div class="empty-queue" style="height: 100%; display: flex; align-items: center; justify-content: center;">
                        No attendance data received yet
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <h2>Quick Actions</h2>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <form method="post" action="/send_command" style="margin: 0;">
                    <input type="hidden" name="endpoint" value="/iclock/getrequest.aspx">
                    <input type="hidden" name="command" value="GET ATTLOG">
                    <button type="submit" class="btn-small" style="width: 100%;">üì• Get Attendance</button>
                </form>
                <form method="post" action="/send_command" style="margin: 0;">
                    <input type="hidden" name="endpoint" value="/iclock/getrequest.aspx">
                    <input type="hidden" name="command" value="INFO">
                    <button type="submit" class="btn-small" style="width: 100%;">üì± Device Info</button>
                </form>
                <form method="post" action="/send_command" style="margin: 0;">
                    <input type="hidden" name="endpoint" value="/iclock/getrequest.aspx">
                    <input type="hidden" name="command" value="GET OPTION">
                    <button type="submit" class="btn-small" style="width: 100%;">‚öôÔ∏è Get Options</button>
                </form>
                <form method="post" action="/send_command" style="margin: 0;">
                    <input type="hidden" name="endpoint" value="/iclock/getrequest.aspx">
                    <input type="hidden" name="command" value="SET OPTION RTLOG=1">
                    <button type="submit" class="btn-small" style="width: 100%;">‚ö° Enable RTLOG</button>
                </form>
                <form method="post" action="/send_command" style="margin: 0;">
                    <input type="hidden" name="endpoint" value="/iclock/getrequest.aspx">
                    <input type="hidden" name="command" value="SET OPTION PUSH=1">
                    <button type="submit" class="btn-small" style="width: 100%;">üì≤ Enable PUSH</button>
                </form>
                <form method="post" action="/send_command" style="margin: 0;">
                    <input type="hidden" name="endpoint" value="/iclock/getrequest.aspx">
                    <input type="hidden" name="command" value="CLEAR ATTLOG">
                    <button type="submit" class="btn-small" style="width: 100%;">üßπ Clear Attendance</button>
                </form>
            </div>
        </div>
    </div>

    <footer>
        eSSL / ZKTeco iClock Probe ‚Ä¢ FastAPI ‚Ä¢ AJAX Live Updates ‚Ä¢ No Page Refresh
    </footer>

</div>

<script>
    // Auto-scroll logs to bottom
    const logBox = document.getElementById("logBox");
    const attBox = document.getElementById("attBox");
    
    if (logBox) logBox.scrollTop = logBox.scrollHeight;
    if (attBox) attBox.scrollTop = attBox.scrollHeight;
    
    let refreshInterval;
    let refreshCountdown = 10;
    let isAutoRefresh = true;
    
    // Function to update data via AJAX
    async function refreshData() {
        try {
            const response = await fetch('/get_logs');
            const data = await response.json();
            
            // Update logs
            const logBox = document.getElementById('logBox');
            if (logBox && data.logs) {
                logBox.innerHTML = data.logs.map(line => 
                    `<div class="log-line">${line}</div>`
                ).join('');
                logBox.scrollTop = logBox.scrollHeight;
            }
            
            // Update attendance
            const attBox = document.getElementById('attBox');
            if (attBox && data.attendance) {
                if (data.attendance.length > 0) {
                    attBox.innerHTML = data.attendance.map(line => 
                        `<div class="att-line">${line}</div>`
                    ).join('');
                } else {
                    attBox.innerHTML = '<div class="empty-queue" style="height: 100%; display: flex; align-items: center; justify-content: center;">No attendance data received yet</div>';
                }
                attBox.scrollTop = attBox.scrollHeight;
            }
            
            // Update command queue
            const queueDiv = document.getElementById('commandQueue');
            if (queueDiv && data.queue) {
                if (data.queue.length > 0) {
                    queueDiv.innerHTML = data.queue.map(cmd => 
                        `<div class="queue-item">${cmd}</div>`
                    ).join('');
                } else {
                    queueDiv.innerHTML = '<div class="empty-queue">No commands in queue</div>';
                }
            }
            
            // Update counters
            document.getElementById('logsCount').textContent = data.logs_count;
            document.getElementById('logsCountValue').textContent = data.logs_count;
            document.getElementById('attendanceCount').textContent = data.attendance_count;
            document.getElementById('attendanceCountValue').textContent = data.attendance_count;
            document.getElementById('queueCount').textContent = data.queue_count;
            document.getElementById('queueCountValue').textContent = data.queue_count;
            document.getElementById('deviceSn').textContent = data.device_sn || 'Not detected yet';
            
            // Update last update time
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toISOString() + 'Z';
            document.getElementById('lastUpdateTime').textContent = 'Now';
            
            // Reset countdown
            refreshCountdown = 10;
            
        } catch (error) {
            console.error('Error refreshing data:', error);
        }
    }
    
    // Function to update countdown
    function updateCountdown() {
        if (isAutoRefresh) {
            refreshCountdown--;
            document.getElementById('nextRefresh').textContent = `Next: ${refreshCountdown}s`;
            
            if (refreshCountdown <= 0) {
                refreshData();
                refreshCountdown = 10;
            }
        }
    }
    
    // Initialize auto-refresh
    function initAutoRefresh() {
        const autoRefreshCheckbox = document.getElementById('autoRefresh');
        if (autoRefreshCheckbox) {
            isAutoRefresh = autoRefreshCheckbox.checked;
            
            // Clear existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // Set up new interval if auto-refresh is enabled
            if (isAutoRefresh) {
                refreshInterval = setInterval(updateCountdown, 1000);
                document.getElementById('nextRefresh').textContent = `Next: ${refreshCountdown}s`;
            } else {
                document.getElementById('nextRefresh').textContent = 'Auto-refresh off';
            }
            
            // Add event listener for checkbox
            autoRefreshCheckbox.addEventListener('change', function() {
                isAutoRefresh = this.checked;
                if (isAutoRefresh) {
                    refreshCountdown = 10;
                    refreshInterval = setInterval(updateCountdown, 1000);
                    document.getElementById('nextRefresh').textContent = `Next: ${refreshCountdown}s`;
                } else {
                    clearInterval(refreshInterval);
                    document.getElementById('nextRefresh').textContent = 'Auto-refresh off';
                }
            });
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initAutoRefresh();
        
        // Initial refresh after 2 seconds
        setTimeout(refreshData, 2000);
        
        // Also refresh when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                refreshData();
            }
        });
    });
    
    // Manual refresh button
    window.refreshData = refreshData;
</script>

</body>
</html>